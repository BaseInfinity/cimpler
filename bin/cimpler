#!/usr/bin/env node

var net        = require('net'),
util           = require('util'),
fs             = require('fs'),
childProcess   = require('child_process'),
tcpTrigger     = require('../lib/tcp-trigger'),
Git            = require('../lib/git'),
git            = new Git(),
error          = (util.error || console.log),
execOptions    = {},
build          = {},
args           = require('optimist')
   .demand(1)
   .usage("Usage: cimpler test [-b branch-name]")
   .options('branch', {
      alias: 'b',
      describe: 'Name of the branch to test (defaults to current)'
   })
   .options('port', {
      alias: 'p',
      describe: 'TCP port of the cimpler server (defaults to value in config.js)'
   }).argv;

git.remote(function(remote, repoPath) {
   build.repo = remote || repoPath;
   getBranch();
});

function getBranch() {
   if (args.branch) {
      build.branch = args.branch;
      return tcpTrigger(build, args.port);
   }

   exec("git symbolic-ref HEAD", function(stdout) {
      // output == "refs/heads/branch"
      build.branch = stdout.trim().split('/').pop();
      tcpTrigger(build, args.port);
   });
}

function exec(cmd, callback) {
   childProcess.exec(cmd, execOptions, function(err, stdout) {
      if (err) {
         error("Command failed: " + cmd);
         error(err.toString());
         process.exit(1);
      }
      callback(stdout.toString());
   });
}

