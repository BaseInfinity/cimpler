#!/usr/bin/env node

var net        = require('net'),
util           = require('util'),
fs             = require('fs'),
childProcess   = require('child_process'),
tcpTrigger     = require('../lib/tcp-trigger'),
Git            = require('../lib/git'),
git            = new Git(),
error          = (util.error || console.log),
build          = {},
args           = require('optimist')
   .demand(1)
   .usage("Usage: cimpler test [-b branch-name]")
   .options('branch', {
      alias: 'b',
      describe: 'Name of the branch to test (defaults to current)'
   })
   .options('port', {
      alias: 'p',
      describe: 'TCP port of the cimpler server (defaults to value in config.js)'
   }).argv;

git.remote(function(remote, repoPath) {
   build.repo = remote || repoPath;
   getBranch();
});

function getBranch() {
   if (args.branch) {
      build.branch = args.branch;
      tcpTrigger(build, args.port);
   } else {
      git.currentBranch(function(branch) {
         build.branch = branch;
         tcpTrigger(build, args.port);
      });
   }
}

